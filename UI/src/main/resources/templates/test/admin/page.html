<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0,
           minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>무식한 영어 공부</title>

    <!--스타일 초기화  아이콘 폰트 등록-->
    <link rel="stylesheet" href="../css/nomalize.css"/>
    <script src="https://kit.fontawesome.com/f1def33959.js" crossorigin="anonymous"></script>
    <link href="//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css" rel="stylesheet"
          type="text/css"/>

    <!--axios  -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!--css-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
          crossorigin="anonymous">
    <link rel="stylesheet" href="/css/test.admin/page.css" />
</head>

<body>
<header>
    <div class="inner">
        <div class="head-container">
            <div class="head-brand">무식한 영어 공부</div>
            <div class="head-button-container">
                <a class="btn btn-primary head" href="" role="button" style="color: #ffffff"
                   id="home-button">Home</a>
                <button type="button" class="btn btn-primary" id="logout-button">Logout</button>
            </div>
        </div>
    </div>
</header>

<!--타이틀, 관리자 문장 테스트 버튼 있던 자리 일단 삭제함 테스트 페이지 관련 html을 넣어야 하기 때문에.-->
<section>
    <div class="test-inner" style="overflow: hidden">
        <!--        일단 전부 만들지 말고 하나만 만들어 보자.-->
        <!-- style="overflow: hidden  잠시 삭제 노드 복사 잘 되는 지 확인하기 위해서.-->
        <div >
            <div class="all-container", id="all-container">

                <div class="width-container" id="width-container">
                    <div class="test-container" >
                        <div class= "test-inner-container">

                            <div class = "first-line">
                                <div class ="count" id="count">0/15</div>
                                <div class="btn-container">
                                    <button class="answer-btn test-btn btn btn-primary btn-lg"
                                             type="button">정 답</button>
                                    <button class="hint-btn test-btn btn btn-primary btn-lg"
                                             type="button">힌 트</button>
                                </div>
                            </div>

                            <div class = "second-line">
                                <div class="btn-container">
                                    <button class="right-btn test-btn btn btn-primary btn-lg" type="button">맞 음</button>
                                    <button class="wrong-btn test-btn btn btn-primary btn-lg" type="button">틀 림</button>
                                </div>
                            </div>

                            <div class = "third-line">
                                <div class="korean-text">번 역</div>
                                <div class="korean-data" id="korean-data">식은 죽 먹기지</div>
                            </div>
                            <div class = "fourth-line">
                                <div class="english-text">영 어</div>
                                <div class="english-data" id="english-data">  </div>
                            </div>
                        </div>
                    </div>
                </div>



            </div>
        </div>

    </div>
</section>

<script th:inline="javascript">
  const apiUrl = [[${@environment.getProperty('url.api')}]];
  const uiUrl = [[${@environment.getProperty('url.ui')}]];

  //home button
  document.getElementById("home-button").href = "http://" + uiUrl;

  //logout button
  let logoutButton = document.getElementById("logout-button");
  logoutButton.onclick = function () {
    window.localStorage.removeItem("Authorization");
    location.href = "http://" + uiUrl + "/user/page";
  };
  //userId
  let userId;

  //JWT 토큰
  let jwtToken = localStorage.getItem("Authorization")

  let testData= [ {"id":1,"korean":"식은 죽 먹기지","english":"A piece of cake","hint":"x"},
    {"id":2,"korean":"당근 빠따!","english":"Absolutely.","hint":"x"},
    {"id":3,"korean":"먼저 가세요.","english":"After you.","hint":"x"},
    {"id":4,"korean":"항상 그렇지요","english":"Always.","hint":"x"},
    {"id":5,"korean":"사양하지 마세요","english":"Be my guest.","hint":"x"},
    {"id":6,"korean":"샘이라고 불러 주세요","english":"Call me Sam, please.","hint":"x"},
    {"id":7,"korean":"계산서 좀 주세요","english":"Check, please","hint":"x"},
    {"id":8,"korean":"너무 심각하게 그러지 말아요","english":"Don’t get too serious","hint":"x"},
    {"id":9,"korean":"겸손해 하지 말아요","english":"Don't be modest","hint":"x"},
  ];

  let allContainer = document.getElementsByClassName("all-container")[0];


  window.onload =function () {
    //유저 권한 확인하기
    axios({
      url: "http://"+apiUrl+"/api/user/manage/check",
      method: "get",
      headers: {
        "Authorization": jwtToken
      }
    })
    .then(function (response) {
      console.log(response)
      // let testNode = document.getElementById("width-container");
      // console.log(testNode);
      // // let cloneNode = testNode.cloneNode(true);
      // // console.log(cloneNode);
      // // testNode.appendChild(cloneNode);
      // // elementById.after(testNode);
      //
      // //data안에 값 만들 때 해당 사용자 id도 넣어주면 좋다.
      //
      // let length = testData.length;
      // //let 이전 노드 여기다가 저장한 후에 여기에서 붙이기
      // let previousNode = testNode;
      // for (let i = 0; i < testData.length; i++) {
      //   let cloneNode = previousNode.cloneNode(true);
      //   // console.log("잘생 성 되는 지 확인" + cloneNode);
      //   // console.log(cloneNode);
      //   cloneNode.setAttribute("data", testData[i]);
      //   cloneNode.id = i;
      //
      //   previousNode.after(cloneNode);
      //   //끝나면 previous 교체
      //   previousNode = cloneNode;
      // }
      //
      // //아에 뒤쪽에 해둘까.
      // for (let i = 0; i < testData.length; i++) {
      //   let currentNode = document.getElementById(i.toString());
      //   let elementsByClassName = document.getElementById(i.toString()).getElementsByClassName("count")[0];
      //   // console.log(elementsByClassName);
      //   elementsByClassName.innerText = i+1 + "/" + length;
      //
      //   currentNode.getElementsByClassName("korean-data")[0].innerText = testData[i].korean;
      //   // currentNode.getElementsByClassName("english-data")[0].innerText = testData[i].english;
      //
      //
      //   //여기다가 버튼에다가
      //   //여기 안에서 다 처리하면 될듯
      //   //정답 버튼 클릭
      //   let answerButton = currentNode.getElementsByClassName("answer-btn")[0];
      //   answerButton.onclick = function () {
      //     currentNode.getElementsByClassName("english-data")[0].innerText = testData[i].english;
      //   }
      //   let hintButton = currentNode.getElementsByClassName("hint-btn")[0];
      //   hintButton.onclick = function () {
      //     currentNode.getElementsByClassName("english-data")[0].innerText = testData[i].hint;
      //   }
      //
      //   let rightButton = currentNode.getElementsByClassName("right-btn")[0];
      //   rightButton.onclick = function () {
      //     // console.log("맞음")
      //     // console.log(i);
      //     allContainer.style.transform = 'translate('+(-800*(i+1)).toString()+'px)';
      //   };
      //
      //   let wrongButton = currentNode.getElementsByClassName("wrong-btn")[0];
      //   wrongButton.onclick = function () {
      //     // console.log("틀림")
      //     // console.log(i);
      //     allContainer.style.transform = 'translate('+(-800*(i+1)).toString()+'px)';
      //   };
      //
      //   //마지막 문제시에 체크한다음 사용자 페이지로 이동하기.
      //
      // }
      //
      // //그리고 처음 노드를 삭제한다.
      // testNode.remove();
    })
    .catch(function (error) {
      console.log(error)
      location.href="http://"+uiUrl+"/user/manage/login"
    });

    //여기부터 작성 - 테스트 페이지 만들기
    //로컬스토리지 비어 있으면 체크로 돌아가기
    let condition = localStorage.getItem("AdminTestCondition");
    if (condition === null) {
      location.href = "http://" + uiUrl + "/user/test/admin/check";
    }
    let parseCondition = JSON.parse(condition);
    userId = parseCondition.userId;
    console.log(parseCondition);

    //axios 수신해서, 가로 길이 정하기 유의하면서 하기.
    axios({
      url: "http://"+apiUrl+"/api/admin/test/list",
      method: 'put',
      data: {
        userId: parseCondition.userId,
        grammar: parseCondition.grammar,
        situation: parseCondition.situation,
        check: parseCondition.check
      }

    })
    .then(function (response) {
      console.log(response);
      makeTest(response.data);
    })
    .catch(function (error) {
      console.log(error)
      alert("[실패] 테이블 정보 가져오기에 실패하였습니다.");
    });
  }
  function makeTest(dataList) {


    let testNode = document.getElementById("width-container");
    let length = dataList.length;
    //데이터리스트 길이 만큼 와이드 넓이 설정하기.
    document.getElementById("all-container").style.width = 800 * (length + 1) + 'px';

    let previousNode = testNode;
    for (let i = 0; i < dataList.length; i++) {
      let cloneNode = previousNode.cloneNode(true);
      cloneNode.setAttribute("data", dataList[i]);
      cloneNode.id = i;
      previousNode.after(cloneNode);
      previousNode = cloneNode;
    }

    for (let i = 0; i < dataList.length; i++) {
      let currentNode = document.getElementById(i.toString());
      //정답을 확인해야 넘어 갈 수 있도록 하기
      currentNode.setAttribute("answerCheck", "no");

      let elementsByClassName = document.getElementById(i.toString()).getElementsByClassName("count")[0];
      elementsByClassName.innerText = i+1 + "/" + length;
      currentNode.getElementsByClassName("korean-data")[0].innerText = dataList[i].korean;

      let answerButton = currentNode.getElementsByClassName("answer-btn")[0];
      answerButton.onclick = function () {
        currentNode.getElementsByClassName("english-data")[0].innerText = dataList[i].english;
        //맞음을 클리해야 다음으로 넘어갈 수 있도록 하기.
        currentNode.setAttribute("answerCheck", "yes")

      }

      let hintButton = currentNode.getElementsByClassName("hint-btn")[0];
      hintButton.onclick = function () {
        currentNode.getElementsByClassName("english-data")[0].innerText = dataList[i].hint;
      }

      let rightButton = currentNode.getElementsByClassName("right-btn")[0];
      rightButton.setAttribute("id", "rightButton");
      rightButton.setAttribute("data", dataList[i]);
      rightButton.onclick = function () {
        let answerCheck = currentNode.getAttribute("answerCheck");
        if (answerCheck === "yes") {
          //이동
          allContainer.style.transform = 'translate('+(-800*(i+1)).toString()+'px)';
          //맞음 보내기
          axios({
            url: "http://"+apiUrl+"/api/admin/test/check",
            method: 'post',
            data: {
              userId: userId,
              sentenceId : dataList[i].sentenceId,
              check: "CORRECT"
            }

          })
          .then(function (response) {
            console.log("correct 완료")
            console.log(response);
            //마지막 테스트 클릭 시
            if (i === dataList.length-1) {
              //localstorage지우기
              localStorage.removeItem("AdminTestCondition");
              location.href = "http://" + uiUrl + "/user/test/admin/check";
            }
          })
          .catch(function (error) {
            console.log("correct 실패")
            console.log(error)
          });
        }else {
          alert("정답을 확인해주세요")
        }
      };

      let wrongButton = currentNode.getElementsByClassName("wrong-btn")[0];
      wrongButton.setAttribute("id", "wrongButton");
      wrongButton.setAttribute("data", dataList[i]);
      wrongButton.onclick = function () {
        let answerCheck = currentNode.getAttribute("answerCheck");
        if (answerCheck === "yes") {
          allContainer.style.transform = 'translate('+(-800*(i+1)).toString()+'px)';
          axios({
            url: "http://"+apiUrl+"/api/admin/test/check",
            method: 'post',
            data: {
              userId: userId,
              sentenceId : dataList[i].sentenceId,
              check: "WRONG"
            }

          })
          .then(function (response) {
            console.log("wrong 완료")
            console.log(response);
            if (i === dataList.length-1) {
              localStorage.removeItem("AdminTestCondition");
              location.href = "http://" + uiUrl + "/user/test/admin/check";
            }
          })
          .catch(function (error) {
            console.log("wrong 실패")
            console.log(error)
          });
        }else {
          alert("정답을 확인해주세요")
        }
      };
    }
    //처음 클론 노드용 엘레멘트 삭제.
    testNode.remove();
  }
</script>
</body>
</html>